name: Custom build # Unfortunately, we cannot modify the name: https://github.community/t/github-actions-dynamic-name-of-the-workflow-with-workflow-dispatch/150327
on:
  workflow_dispatch:
    inputs:
      branchAdapter:
        description: 'Branch of the OpenFOAM adapter to build'
        default: 'develop'
        required: true
      versionOpenFOAM:
        description: 'Version of OpenFOAM to build with'
        required: true
        type: choice
        options:
          - OpenFOAMv2112
          - OpenFOAMv2106
          - OpenFOAMv2012
          - OpenFOAMv2006
          - OpenFOAMv1912
          - OpenFOAM9
          - OpenFOAM8
          - OpenFOAM7
          # We don't have precompiled packages for older versions on this Ubuntu version
      versionpreCICE:
        description: 'Released version of preCICE to build with'
        default: '2.3.0'
        required: true

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - name: Report log
      run: |
        echo "Initiated by: ${{ github.actor }}"
        echo "Adapter version: ${{ github.event.inputs.branchAdapter }}"
        echo "OpenFOAM version: ${{ github.event.inputs.versionOpenFOAM }}"
        echo "preCICE version: ${{ github.event.inputs.versionpreCICE }}"
    - name: Check out repository
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.inputs.branchAdapter }}
    - name: Install OpenFOAM (no cache)
      id: installOpenFOAM
      run: |
        case "${{ github.event.inputs.versionOpenFOAM }}" in
          OpenFOAMv2112)
            wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | sudo bash
            sudo apt-get install openfoam2112-dev;;
          OpenFOAMv2106)
            wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | sudo bash
            sudo apt-get install openfoam2106-dev;;
          OpenFOAMv2012)
            wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | sudo bash
            sudo apt-get install openfoam2012-dev;;
          OpenFOAMv2006)
            wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | sudo bash
            sudo apt-get install openfoam2006-dev;;
          OpenFOAMv1912)
            wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | sudo bash
            sudo apt-get install openfoam1912-dev;;
          OpenFOAM7)
            sudo sh -c "wget -O - https://dl.openfoam.org/gpg.key | apt-key add -"
            sudo add-apt-repository http://dl.openfoam.org/ubuntu
            sudo apt-get update
            sudo apt-get -y install openfoam7;;
          OpenFOAM8)
            sudo sh -c "wget -O - https://dl.openfoam.org/gpg.key | apt-key add -"
            sudo add-apt-repository http://dl.openfoam.org/ubuntu
            sudo apt-get update
            sudo apt-get -y install openfoam8;;
          OpenFOAM9)
            sudo sh -c "wget -O - https://dl.openfoam.org/gpg.key | apt-key add -"
            sudo add-apt-repository http://dl.openfoam.org/ubuntu
            sudo apt-get update
            sudo apt-get -y install openfoam9;;
          *)
            echo "I cannot find ${{ github.event.inputs.branchAdapter }} in my known options."
            exit 1;;
        esac
    - name: Install preCICE (no cache)
      run: |
        wget "https://github.com/precice/precice/releases/download/v${{ github.event.inputs.versionpreCICE }}/libprecice2_${{ github.event.inputs.versionpreCICE }}_focal.deb"
        sudo apt install "./libprecice2_${{ github.event.inputs.versionpreCICE }}_focal.deb"
    - name: Build OpenFOAM-preCICE adapter
      run: |
        case "${{ github.event.inputs.versionOpenFOAM }}" in
          OpenFOAMv2112)
            /usr/bin/openfoam2112 ./Allwmake;;
          OpenFOAMv2106)
            /usr/bin/openfoam2106 ./Allwmake;;
          OpenFOAMv2012)
            /usr/bin/openfoam2012 ./Allwmake;;
          OpenFOAMv2006)
            /usr/bin/openfoam2006 ./Allwmake;;
          OpenFOAMv1912)
            /usr/bin/openfoam1912 ./Allwmake;;
          OpenFOAM7)
            . /opt/openfoam8/etc/bashrc && ./Allwmake;;
          OpenFOAM8)
            . /opt/openfoam8/etc/bashrc && ./Allwmake;;
          OpenFOAM9)
            . /opt/openfoam9/etc/bashrc && ./Allwmake;;
        esac
